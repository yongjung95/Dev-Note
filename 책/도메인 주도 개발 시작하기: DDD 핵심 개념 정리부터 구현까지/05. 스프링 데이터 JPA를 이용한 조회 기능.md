# 05장 스프링 데이터 JPA를 이용한 조회 기능

## 5.1 시작에 앞서
- **CORS**
  - 명령 모델과 조회 모델을 분리하는 패턴.
  - 명령 모델 : 상태를 변경하는 기능을 구현할 때 사용한다.
    - 예) 회원 가입, 암호 변경, 주문 취소처럼 상태(데이터)를 변경하는 기능을 구현할 때 사용.
    - 엔티티, 애그리거트, 리포지터리 등 도메인 모델은 명령 모델로 주로 사용.
  - 조회 모델 : 데이터를 조회하는 기능을 구현할 때 사용한다.
    - 예) 주문 목록, 주문 상세처럼 데이터를 보여주는 기능을 구현할 때 사용.
    - 정렬, 페이징, 검색 조건 지정과 같은 기능은 조회 기능에 사용.


## 5.2 검색을 위한 스펙
- **스펙**
  - 검색 조건을 다양하게 조합할 때 사용한다.
  - 애그리거트가 특정 조건을 충족하는지를 검사할 때 사용하는 인터페이스.
  ```java
  public interface Speficiation<T> {
    public boolean isSatisfiedBy(T agg);
  }
  ```
  - agg 파라미터는 검사 대상이 되는 객체다.
  - 스펙을 리포지터리에 사용하면 agg는 **애그리거트 루트**가 되고, 스펙을 DAO에 사용하면 agg는 **검색 결과**로 리턴할 데이터 객체가 된다.
- 스펙의 용도
  - 리포지터리나 DAO는 검색 대상을 걸러내는 용도로 사용한다.
  - 리포지터리가 스펙을 이용해서 검색 대상을 걸러주므로 특정 조건을 충족하는 **애그리거트**를 찾고 싶으면 원하는 스펙을 생성해서 리포지터리에 전달해 주기만 하면 된다.


## 5.3 스프링 데이터 JPA를 이용한 스펙 구현
- 책 참고.


## 5.4 리포지터리/DAO에서 스펙 사용하기
- 책 참고.


## 5.5 스펙 조합
- 스프링 데이터 JPA가 제공하는 스펙 인터페이스는 스펙을 조합할 수 있는 두 메서드를 제공한다.
  - and() 메서드 : 두 스펙을 모두 충족하는 조건을 표현하는 스펙을 생성한다.
  - or() 메서드 : 두 스펙 중 하나 이상 축종하는 조건을 표현하는 스펙을 생성한다.
- 조건을 반대로 적용할 때 사용하는 메서드
  - not() 메서드
- null 가능성이 있는 스펙 객체와 다른 스펙을 조합해야 할 때 사용하는 메서드
  - where() 메서드 : 스펙 인터페이스의 정적 메서드로 null을 전달하면 아무 조건도 생성하지 않는 스펙 객체를 리턴하고, null이 아니면 인자로 받은 스펙 객체를 그대로 리턴한다.


## 5.6 정렬 지정하기
- 스프링 데이터 JPA는 두 가지 방법을 사용해서 정렬을 지정할 수 있다.
  - 메서드 이름에 OrderBy를 사용해서 정렬 기준 지정
    - 두 개 이상의 프로퍼티에 대한 정렬 순서를 지정하려면 먼저 작성하면 된다.
    - 젖열 기준 프로퍼티가 두 개 이상이면 메서드 일므이 길어지는 단점이 있다.
  - Sort를 인자로 전달
    - 스프링 데이터 JPA는 파라미터로 전달 받은 Sort를 사용해서 알맞게 정렬 쿼리를 생성한다.
    - 두 개 이상의 정렬 순서를 지정하고 싶다면 Sort#and() 메서드를 사용해서 두 Sort 객체를 연결하면 된다.


## 5.7 페이징 처리하기
- **목록을 보여줄 때 전체 데이터 중 일부만 보여주는 페이징 처리는 기본**이다.
- 스프링 데이터 JPA는 페이징 처리를 위해 Pageable 타입을 사용한다.
- Pageable
  - ```java
    Sort sort = Sort.by("name").descending();
    PageRequest pageReq = PagerRequest.of(1, 10, sort);
    List<MemberData> user = memberDataDao.findByNameLike("사용자%", pageReq);
    ```
  - PageRequest 클래스를 이용해서 생성한다.
  - 생성 시에 Sort를 사용하면 정렬 순서를 지정할 수 있다.
- Page 타입
  - ```java
    Page<MemberData> findByBlocked(boolean blocked, Pageable pageable);
    ```
  - 데이터 목록뿐만 아니라 조건에 해당하는 전체 개수도 구할 수 있다.
  - **Page는 전체 개수, 페이지 개수 등 페이징 처리에 필요한 데이터도 함께 제공**한다.
  - 주의점
    - 페이징 처리와 관련된 정보가 필요 없다면 Page 리턴 타입이 아닌 List를 사용해서 불필요한 COUNT 쿼리를 실행하지 않도록 한다.
    - 스펙을 사용하면 메서드에 Pageable 타입을 사용하면 리턴 타입이 Page가 아니어도 COUNT 쿼리를 실행한다.
      - 예) ```
            List<MemberData> findAll(Specification<MemberData> spec, Pageable pageable);
            ```
        - 해당 메서드를 실행하면 페이지 관련 정보가 필요 없더라도 COUNT 쿼리를 실행한다.
- findFirstN
  - 처음부터 N개의 데이터가 필요할 때 Pageable을 사용하지 않는 방법.
  - First 대신 Top를 사용해도 된다.
    - First 나 Top 뒤에 숫자가 없으면 한 개 결과만 리턴한다.


## 5.8 스펙 조합을 위한 스펙 빌더 클래스
- 스펙 빌더
    ```java
    Specification<MemberData> spec = SpectBuilder.builder(MemberData.class)
            .ifTrue(searchRequest.isonlyNotBlocked(),
            () -> MemberDataSpecs.nonBlocked())
            .ifHasTest(searchRequest.getName(),
            name -> MemberDataSpecs.nameLike(searchRequest.getName()))
            .toSpec();
    ```
  - 메서드를 사용해서 조건을 표현하고 메서드 호출 체인으로 연속된 변수 할당을 줄여 코드 가독성을 높이고 구조가 단순한 방식.


## 5.9 동적 인스턴스 생성
- JPA는 쿼리 결과에서 임의의 객체를 동적으로 생성할 수 있는 기능을 제공한다.
- 조회 전용 모델을 만드는 이유
  - 표현 영역을 통해 사용자에게 데이터를 보여주기 위함이다.
  - 많은 프레임워크는 새로 추가한 밸류 타입을 알맞은 형식으로 출력하지 못하므로 **값을 기본 타입으로 변환하면 편리**하다.
- 동적 인스턴스의 장점
  - **JPQL를 그대로 사용하므로 객체 기준으로 쿼리를 작성하면서도 동시에 지연/즉시 로딩과 같은 고민 없이 원하는 모습으로 데이터를 조회할 수 있다는 점**이다.


## 5.10 하이버네이트 @Subselect 사용
- @Subselect
  - 하이버네이트가 제공하는 JPA 확장 기능.
  - 쿼리 결과를 @Entity로 매핑할 수 있는 유용한 기능.
  - 조회 쿼리를 값으로 갖는다.
  - DBMS가 여러 테이블을 조인해서 조회한 결과를 한 테이블처럼 보여주기 위한 용도로 뷰를 사용하는 것처럼 @Subselect를 사용하면 쿼리 실행 결과를 매핑할 테이블처럼 사용한다.
  - 뷰를 수정할 수 없듯이 @Subselect로 조회한 @Entity 역시 수정이 불가능하다.
    - 매핑 한 테이블이 없으므로 에러가 발생.
    - @Immutable을 사용하면 하이버네이트는 해당 엔티티의 매핑 필드/프로퍼티가 변경되도 DB에 반영하지 않고 무시한다.
  - 장점
    - 일반 @Entity와 같기 때문에, EntityManager#find(), JPQL, Criteria를 사용해서 조회할 수 있다.
- @Synchronize
  - 특별한 이유가 없으면 하이버네이트는 트랜잭션을 커밋하는 시점에 변경사항을 DB에 반영하므로, 변경 내역을 아직 반영하지 않은 상태에서 조회할 수 있다.
  - 해당 엔티티와 관련된 테이블 목록을 명시하면, 하이버네이트는 해당 엔티티를 로딩하기 전에 지정한 테이블과 관련된 변경이 발생하면 **플러시**를 먼저 한다.
  - @Synchronize가 명시된 엔티티는 롣이하는 시점에서 변경 내역이 **반영**된다.
