# 11장 CQRS

## 11.1 단일 모델의 장점
- **조회 화면 특성상 조회 속도가 빠르면 빠를수록 좋은데 여러 애그리거트의 데이터가 필요하면 구현 방법을 고민**해야 한다.
  - 조회 기능을 구현하려면 여러 애그리거트에서 데이터를 가져와야 할 때가 많다.
  - 식별자를 이용해 애그리거트를 참조할 때는 즉시 로딩과 같이 JPA의 쿼리 관련 최적화 기능을 사용할 수 없다.
  - 직접 참조하는 방식은 조회 화면 특성에 따라 같은 연관도 즉시 로딩이나 지연 로딩으로 처리해야 하고, DBMS가 제공하는 전용 기능이 필요하면 JPA의 
  네이티브 쿼리를 사용해야 한다.
- 위의 고민이 발생하는 이유는 **시스템 상태를 변경할 때와 조회할 때 단일 도메인 모델을 사용하기 때문**이다.
  - 객체 지향으로 도메인 모델을 구현할 때 주로 사용하는 ORM 기법은 **도메인 상태 변경 긴으을 구현하는 데는 적합하지만, 여러 애그리거트에서 데이터를 가져와 출력하는 기능을 구현하기에는 고려할 게 많아서 구현을 복잡하게 만드는 원인**이 된다.
- 구현 복잡도를 낮추는 간단한 방법은 **상태 변경을 위한 모델과 조회를 위한 모델을 분리하는 것**이다.


## 11.2 CQRS
- 시스템이 제공하는 기능은 크게 두 가지로 나눌 수 있다.
  - **상태를 변경하는 기능**
    - 예) 새로운 주문을 생성하거나, 배송지 정보를 변경하거나, 회원 암호를 변경하는 기능 등
    - **개발자는 현재 저장하고 있는 데이터를 변경하는 방식으로 기능을 구현**
    - 도메인 모델 관점에서 상태 변경 기능은 **주로 한 애그리거트의 상태를 변경**한다.
  - **사용자 입장에서 상태 정보를 조회하는 기능**
    - 예) 주문 상세 내역보기, 게시글 목록 보기, 회원 정보 보기, 판매 통계 보기 등
    - 조회 기능은 **필요한 데이터를 읽어와 UI를 통해 보여주는 방식으로 구현**한다.
    - 조회 기능에 필요한 데이터를 표시하려면 두 개 이상의 애그리거트가 필요할 때가 많다.
- 상태를 변경하는 범위와 상태를 조회하는 범위가 정확하게 일치하지 않기 때문에 단일 모델로 두 종류의 기능을 구현하면 모델이 불필요하게 복잡해진다.
  - 단일 모델을 사용할 때 발생하는 복잡도를 해결하기 위해 사용하는 방법이 바로 **CQRS**이다.

### **CQRS**
![img.png](사진폴더/11/11.2%20CQRS%20패턴.png)
- Command Query Responsibility Segregation의 약자
- **상태를 변경하는 명령을 위한 모델과 상태를 제공하는 조회를 위한 모델을 분리하는 패턴**
- CQRS는 **복잡한 도메인에 적합**하다.
  - 도메인이 복잡할수록 명령 기능과 조회 기능이 다루는 데이터 범위에 차이가 난다.
  - 이 두 기능을 **단일 모델로 처리하면 조회 기능의 로직 속도를 위해 모델 구현이 필요 이상으로 복잡**해진다.
- CQRS를 사용하면 **각 모델에 맞는 구현 기술을 선택**할 수 있다.
  - 예) 명령 모델은 객체 지향에 기반해서 도메인 모델을 구현하기에 좋은 JPA / 조회 모델은 DB 테이블에서 SQL로 데이터를 조회할 때 좋은 마이바티스
- 구현 방법
  - **명령 모델과 조회모델은 서로 다른 기술을 이용해서 구현할 수 있다.**
  
    ![img.png](사진폴더/11/11.3%20명령%20모델과%20조회%20모델은%20서로%20다른%20기술을%20이용해서%20구현할%20수%20있다.png)

    - 조회 모델에는 응용 서비스가 존재하지 않는다.
      - 단순히 데이터를 읽어와 조회하는 기능은 응용 로직이 복잡하지 않기 때문에 컨트롤러에서 바로 DAO를 실행해도 무방하다.
      - 물론 데이터를 표현 영역에 전달하는 과정에서 몇 가지 로직이 필요하다면 응용 서비스를 두고 로직을 구현하면 된다.
  - **명령 모델과 조회 모델이 같은 구현 기술을 사용할 수 있다.**
    - 예) JPQL을 이용한 동적 인스턴스 생성과 하이버네이트의 `@Subselect`를 이용하는 방법
      - 동적 인스턴스로 사용할 클래스와 `@Subselect`를 적용한 클래스가 조회 모델에 해당한다.
  - **명령 모델과 조회 모델이 서로 다른 데이터 저장소를 사용할 수도 있다.**
    - 예) 명령 모델은 트랜잭션을 지원하는 DBMS, 조회 모델은 조회 성능이 좋은 메모리 기반 NoSQL
    - **두 데이터 저장소 간 데이터 동기화는 이벤트를 활용해서 처리**한다.
    - **명령 모델과 조회 모델이 서로 다른 데이터 저장소를 사용할 경우 데이터 동기화 시점에 따라 구현 방식**이 달라질 수 있다.
      - **실시간 동기화**
        - 명령 모델에서 데이터가 바뀌자마자 변경 내역을 바로 조회 모델에 반영해야 할 때 **동기 이벤트와 글로벌 트랜잭션**을 사용한다.
        - 전반적인 성능(응답 속도와 처리량)이 떨어지는 단점
      - **비동기**
        - 서로 다른 저장소의 데이터를 특정 시간 안에만 동기화해도 될 때 사용한다.
        - 예) 통계 처리 목적으로 조회 전용 저장소는 통계 데이터는 1시간 단위로 최근 데이터를 반영해도 문제가 되지 않을 때가 많다.
- **⚠️주의⚠️**
  - CQRS 패턴을 적용하기 위해 사용해야 할 필수 기술이 따로 존재하는 것은 아니다.
  - JPA만 사용해서 명령 모델과 조회 모델을 구현할 수도 있다.
  - 명령 모델은 JPA로 구현하고, 조회 모델은 직접 SQL을 사용해서 구현할 수도 있다.

### 11.2.1 웹과 CQRS
- 일반적인 웹 서비스는 상태를 변경하는 요청보다 상태를 조회하는 요청이 많다.
- 포털이나 대형 온라인 쇼핑몰과 같이 조회 기능 요청 비율이 월등히 높은 서비스를 만드는 개발팀은 **조회 성능을 높이기 위해 다양한 기법**을 사용한다.
  - 기본적으로 쿼리를 최적화해서 쿼리 실행속도 자체를 높인다.
  - 메모리에 조회 데이털르 캐싱 해서 응답 속도를 높이기도 한다.
  - 조회 전용 저장소를 따로 사용하기도 한다.
- 조회 성능을 높이기 위해 다양한 기법을 사용하는 것은 **결과적으로 CQRS를 적용하는 것과 같은 효과**를 만든다.
  - 메모리에 캐싱 하는 데이터는 DB에 보관된 데이터를 그대로 저장하기 보다는 화면에 맞는 모양으로 변환한 데이터를 캐싱 할 때 성능이 더 유리하다.
    - **조회 전용 모델을 캐시하는 것**
  - 조회 속도를 높이기 위해 쿼리를 최적화한다는 것은 **조회 화면에 보여줄 데이터를 빠르게 읽어올 수 있도록 쿼리를 작성하는 것**이다.
- 대규모 트래픽이 발생하는 웹 서비스는 알게 모르게 CQRS를 적용하게 된다.
  - 단지 명시적으로 명령 모델과 조회 모델을 구분하지 않을 뿐.
  - **조회 속도를 높이기 위해 별도 처리를 하고 있다면 명시적으로 명령 모델과 조회 모델을 구분**하자.
    - **조회 기능 때문에 명령 모델이 복잡해지는 것을 막을 수 있고, 명령 모델에 관계 없이 조회 기능에 특화된 구현 기법을 보다 쉽게 적용**할 수 있다.

### 11.2.2 CQRS 장단점
- 장점
  - **명령 모델을 구현할 때 도메인 자체에 집중할 수 있다.**
    - 복잡한 도메인은 주로 상태 변경 로직이 복잡한데 명령 모델과 조회모델을 구분하면 조회 성능을 위한 코드가 명령 모델에 없으므로 **도메인 로직을 구현하는 데 집중**할 수 있다.
    - **명령 모델에서 조회 관련 로직이 사라져 복잡도가 낮아진다.**
  - **조회 성능을 향상시키는 데 유리하다.**
    - 조회 단위로 캐시 기술을 적용할 수 있고, 조회에 특화된 쿼리를 마음대로 사용할 수도 있다.
    - 캐시 뿐만 아니라 조회 전용 저장소를 사용하면 조회 처리량을 대폭 늘릴 수도 있다.
    - **조회 전용 모델을 사용하기 때문에 조회 성능을 높이기 위한 코드가 명령 모델에 영향**을 주지 않는다.
- 단점
  - **구현해야 할 코드가 많아진다.**
    - 단일 모델을 사용할 때 발생하는 복잡함 때문에 발생하는 구현 비용과 조회 전용 모델을 만들 때 발생하는 구현 비용을 따져야 한다.
    - 도메인이 복잡하거나 대규모 트래픽이 발생하는 서비스라면 **조회 전용 모델을 만드는 것이 향후 유지 보수에 유리**하다.
    - 도메인이 단순하거나 트래픽이 많지 않은 서비스라면 조회 전용 모델을 따로 만들 때 얻을 이점이 있는지 따져봐야 한다.
  - **더 많은 구현 기술이 필요하다.**
    - 명령 모델과 조회 모델을 다른 구현 기술을 사용해서 구현하기도 하고 경우에 따라 다른 저장소를 사용하기도 한다.
    - 데이터 통기활르 위해 메시징 시스템을 도입해야 할 수도 있다.
- 정리
  - **도메인이 복잡하지 않은데 CQRS를 도입하면 두 모델을 유지하는 비용만 높아지고 얻을 수 있는 이점은 없다.**
  - **반면에 트랙이 높은 서비스인데 단일 모델을 고집하면 유지 보수 비용이 오히려 높아질 수 있으므로 CQRS 도입을 고려**하자.